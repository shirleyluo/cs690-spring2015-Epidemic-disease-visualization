<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="initial-scale=1, maximum-scale=1">
</head>
<title>Epidemic Disease Visualization</title>
<link rel="stylesheet" href="css/jquery.mobile-1.4.5.min.css"/>
<script src="js/jquery-2.1.3.js"></script>
<script src="js/jquery.mobile-1.4.5.js"></script>
<script src="d3/d3.min.js"></script>
<script type="text/javascript" src="https://maps.google.com/maps/api/js?sensor=true&libraries=places"></script>

<script type="text/javascript" src="cordova.js"></script>

<style>


    .ui-page, .ui-header, .ui-content, #gmap, #gmap-influenza {

        /*margin-top: 20px;*/
    }

    .ui-panel {
        margin-top: 0px;
    }

    #btn-menu {
        margin-top: 3px;

        margin-left: 5px !important;
    }

    #btn-search, #btn-search-influenza {
        margin-top: 3px;

        margin-right: 5px !important;
    }

    .ui-header, .ui-grid-b, .ui-block-a, .ui-block-b, .ui-block-c {

        /*width: 100%;*/

        background: #FFFFFF;
        opacity: 1;
        line-height: 0px;
        max-height: 36px !important;

    }

    p {
        margin-left: 10px;
    }

    html, body, .ui-page {
        width: 100% !important;
        height: 100% !important;
        padding: 0px !important;

    }

    .ui-content {
        position: absolute;
        margin-top: 36px;

        width: 100% !important;

        padding: 0px !important;

        height: calc(100% - 36px) !important;

    }

    #gmap, #gmap-influenza {

        width: 100% !important;
        height: 100% !important;

    }

    #pac-input, #pac-input-influenza {
        display: none;
        width: 100% !important;
        margin-top: 2px;
        border-left-width: 0px;
        padding-left: 0px;
        padding-right: 0px;
        border-right-width: 0px;

        margin-left: auto;
        margin-right: auto;

    }

    #menu-list {

        background-color: #6495ED;

        color: #FFFFFF;
        text-shadow: 2px 0 #111;
        font-size: larger;
        font-family: fantasy;
    }

    #menuPanel {
        background-color: WhiteSmoke;
    }

    .locations, .locations svg {
        position: absolute;
    }

    .locations svg {
        width: 60px;
        height: 20px;
        padding-right: 100px;
        font: 10px sans-serif;
    }

    .locations circle {
        fill: yellow;
        stroke: black;
        stroke-width: 1.5px;
    }

    /* Style for Ebola Trend */

    .axis path,
    .axis line {
        fill: none;
        stroke: #000;
        shape-rendering: crispEdges;
    }

    .x.axis path {
        display: none;
    }

    .y.axis {
        font-size: 8px !important;
    }

    .line {
        fill: none;
        stroke: steelblue;
        stroke-width: 1.5px;
    }


</style>

<script> <!-- Script for Ebola -->
// Common menu pannel, shared by all pages. 
$(document).on("pagecreate", function () {
    $("body > [data-role='panel']").panel();

    $("body > [data-role='panel'] [data-role='listview']").listview();
});

var map;
var geocoder;
var center = new google.maps.LatLng(-34.397, 150.644);
var e_center = new google.maps.LatLng(9.430009, -13.083386);
var showedInfoWindow = null;

//     $(window).on('load', '#ebola', function () {
//     $(this).trigger('resize');
// });


function getcurrentlatlong() {


    if (navigator.geolocation) {


        navigator.geolocation.getCurrentPosition(onSuccess, onError, {enableHighAccuracy: true});

    }
    else {

        alert("navigator.geolocation not supported");
        initialize();

    }

}

function onSuccess(position) {

    var lat = position.coords.latitude;
    var lng = position.coords.longitude;

    center = new google.maps.LatLng(lat, lng);

    initialize();

}

function onError(error) {

    alert("Getting the error" + error.code + "\nerror mesg :" + error.message);
}


function initialize() {
    geocoder = new google.maps.Geocoder();


    var myOptions = {
        zoom: 7,
        streetViewControl: false,
        mapTypeId: google.maps.MapTypeId.ROADMAP,
        center: e_center,
        mapTypeControl: false
    };
    map = new google.maps.Map(d3.select("#gmap").node(), myOptions);


    var currentLocMarker = new google.maps.Marker({

        position: center,
        map: map,
        animation: google.maps.Animation.BOUNCE
    });

    var input = /** @type {HTMLInputElement}*/ (
            document.getElementById('pac-input'));


    map.controls[google.maps.ControlPosition.TOP_LEFT].push(input);


    var autocomplete = new google.maps.places.Autocomplete(input);
    autocomplete.bindTo('bounds', map);

    var infowindow = new google.maps.InfoWindow();
    var scMarker = new google.maps.Marker({
        map: map,
        anchorPoint: new google.maps.Point(0, -29)
    });

    google.maps.event.addListener(autocomplete, 'place_changed', function () {
        infowindow.close();
        scMarker.setVisible(false);
        var place = autocomplete.getPlace();
        if (!place.geometry) {
            return;
        }

        // If the place has a geometry, then present it on a map.
        if (place.geometry.viewport) {
            map.fitBounds(place.geometry.viewport);
        } else {
            map.setCenter(place.geometry.location);
            map.setZoom(4);  // Why 17? Because it looks good.
        }
        scMarker.setIcon(/** @type {google.maps.Icon} */({
            url: place.icon,
            size: new google.maps.Size(71, 71),
            origin: new google.maps.Point(0, 0),
            anchor: new google.maps.Point(17, 34),
            scaledSize: new google.maps.Size(35, 35)
        }));
        scMarker.setPosition(place.geometry.location);
        scMarker.setVisible(true);

        var address = '';
        if (place.address_components) {
            address = [
                (place.address_components[0] && place.address_components[0].short_name || ''),
                (place.address_components[1] && place.address_components[1].short_name || ''),
                (place.address_components[2] && place.address_components[2].short_name || '')
            ].join(' ');
        }

        infowindow.setContent('<div><strong>' + place.name + '</strong><br>' + address);
        infowindow.open(map, scMarker);
    });

// Set the url to get the latest data from WHO
// Get latest date
    var today = new Date(); // Sat Mar 28 2015 23:47:31 GMT-0700 (PDT)
    var lastWednDay = today.getDate() - today.getDay() - 4; //18
    var date = new Date(today.setDate(lastWednDay)); // Wed Mar 18 2015 23:46:57 GMT-0700 (PDT)


    Date.prototype.yyyymmdd = function () {

        var yyyy = this.getFullYear().toString();
        var mm = (this.getMonth() + 1).toString(); // getMonth() is zero-based
        var dd = this.getDate().toString();

        return yyyy + '-' + (mm[1] ? mm : "0" + mm[0]) + '-' + (dd[1] ? dd : "0" + dd[0]);
    };
    var dpi = date.yyyymmdd(); // e.g. 2015-03-28

// Get year
    var reportYear = date.getFullYear();

// Get latest week report
    Date.prototype.getWeek = function () {
        var onejan = new Date(this.getFullYear(), 0, 1);
        return Math.ceil((((this - onejan) / 86400000) + onejan.getDay() + 1) / 7);
    };
    // var weekNumber = (new Date()).getWeek() - 2;
    var weekNumber = (new Date()).getWeek() - 3;


    var latest_ebola_url = "http://apps.who.int/gho/athena/xmart/DATAPACKAGEID/" + dpi + "?format=csv&profile=text&filter=COUNTRY:*;EPI_WEEK:" + reportYear + "-W" + weekNumber + ";CASE_DEFINITION:CONFIRMED;INDICATOR_TYPE:SITREP_NEW;EBOLA_DATA_SOURCE:SITREP";

    // alert(latest_ebola_url);

// Load the cases data. When the data comes back, create an overlay.
    d3.csv(latest_ebola_url, function (data) {

                var overlay = new google.maps.OverlayView();
                // Add the container when the overlay is added to the map.
                overlay.onAdd = function () {
                    var layer = d3.select(this.getPanes().overlayLayer).append("div")
                            .attr("class", "locations");


                    overlay.draw = function () {

                        // Scale radious of circle
                        var radiusScale = d3.scale.sqrt()
                                .domain([0, d3.max(data, function (d) {
                                    if (d.Location != "") {
                                        return parseInt(d.Numeric);
                                    }
                                    else {
                                        return 0;
                                    }
                                })]) // Skip country level lines while calculating maximum
                                .range([0.007, 0.08]);
                        // Scale opacity of circle
                        var opacityScale = d3.scale.linear()
                                .domain([0, d3.max(data, function (d) {
                                    if (d.Location != "") {
                                        return parseInt(d.Numeric);
                                    }
                                    else {
                                        return 0;
                                    }
                                })]) // Skip country level lines while calculating maximum
                                .range([0.45, 0.85]);


                        var marker = layer.selectAll("svg")
                                .data(data)

                                .enter().append("svg")
                                .each(transform);

                        // The circle radius is in meters. Due to the map projection, one meter at the equator is smaller that one meter at a higher latitude. So a circle of the same size will appear larger at higher latitudes. To make your circles in pixel sizes, use the map projection fromPointToLatLng and fromLatLngToPoint methods (and draw your own circle, the native google.maps.Circle uses the projection).                                
                        function drawCircle(center, radius, projection) {
                          var i, angle, x1, y1;
                          var circle = [];
                          var point = projection.fromLatLngToPoint(center);
                          var x = point.x;
                          var y = point.y;
                          for (var i = 0; i < 360; i += 10) {
                            angle = i;
                            x1 = radius * Math.cos(angle * Math.PI / 180);
                            y1 = radius * Math.sin(angle * Math.PI / 180);
                            circle.push(projection.fromPointToLatLng(new google.maps.Point(x + x1, y + y1)));
                          }
                          return circle;
                        }
                        function transform(d) {

                            if (d.Location != "" && d["Display Value"] != "0" && d["Display Value"] != "") {
                                // alert(d.Location + "  " + d["Display Value"]);

                                var self = this;
                                var address = d.Location + ", " + d.Country;

                                // Convert address to latlong, then draw red circle on the map
                                function geoProcess(address) {
                                    geocoder.geocode({'address': address}, function (results, status) {
                                                if (status == google.maps.GeocoderStatus.OK) {
                                                    var numOfCases = parseInt(d.Numeric);
                                                    var projection = map.getProjection();
                                                    // Opacity indicates seriousness
                                                    // var op;
                                                    // var rd;
                                                    // if (numOfCases < 5) {
                                                    //     op = 0.45;
                                                    //     rd = Math.sqrt(numOfCases) * 3500;
                                                    // }
                                                    // else if (5 <= numOfCases && numOfCases < 15) {
                                                    //     op = 0.65;
                                                    //     rd = Math.sqrt(numOfCases) * 3500;
                                                    // }
                                                    // else {
                                                    //     op = 0.80;
                                                    //     if (numOfCases < 50) {
                                                    //         rd = Math.sqrt(numOfCases) * 3500;
                                                    //     } else {
                                                    //         rd = Math.sqrt(50)*3500;
                                                    //     }
                                                    // }

                                                    var casesOptions = {
                                                        strokeColor: '#FF0000',
                                                        strokeOpacity: 0,
                                                        strokeWeight: 0,

                                                        fillColor: '#FF0000',
                                                        fillOpacity: opacityScale(numOfCases),
                                                        map: map,
                                                        center: results[0].geometry.location,
                                                        radius: radiusScale(numOfCases),
                                                        path: drawCircle(results[0].geometry.location, radiusScale(numOfCases), projection) // Change from meter measure to pixel measure.
                                                    };
                                                    // console.log(results[0].geometry.location);
                                                    // Add the circle for this city to the map.
                                                    caseCircle = new google.maps.Polygon(casesOptions);



                                                    var infowindow = new google.maps.InfoWindow({
                                                        content: '<p>' + "<strong>Location: </strong>" + address + "<br>" + "<strong>Confirmed cases: </strong>" + numOfCases + "<br>" + "<strong>Week: </strong>" + d["Epi week"] + "<br>" + "<strong>Data source: </strong>" + "WHO Situation report" + "</p>"
                                                    });

                                                    google.maps.event.addListener(caseCircle, 'click', function () {
                                                        if (showedInfoWindow) {
                                                            showedInfoWindow.close();
                                                        }
                                                        infowindow.open(map, caseCircle);
                                                        infowindow.setPosition(results[0].geometry.location);
                                                        showedInfoWindow = infowindow;
                                                    });
                                                }
                                                // If OVER_QUERY_LIMIT happens, retry later
                                                else if (status === google.maps.GeocoderStatus.OVER_QUERY_LIMIT) {
                                                    // alert("OVER_QUERY_LIMIT at " + d.Location + "  " + d["Display Value"]);
                                                    // console.log(d.Location, d["Display Value"]);
                                                    setTimeout(function () {
                                                        geoProcess(address);
                                                    // }, 200);
                                                    }, Math.floor(Math.random() * 2000));  // Randomize the retry process retry time to mitigate the OVER_QUERY_LIMIT a bit.
                                                } else {
                                                    alert("Geocode was not successful for the following reason: " + status);

                                                }
                                            }
                                    )
                                    ;
                                }

                                geoProcess(address);
                            }


                        }
                    };


                };

                // Bind our overlay to the map…
                overlay.setMap(map);
            }
    )
    ;


}


// $(document).on("pageinit", "#ebola", function () {

//     $("#btn-search").click(function () {


//         if ($("#pac-input").is(":visible")) {
//             $("#pac-input").hide();
//         }
//         else {
//             $("#pac-input").show();
//         }

//         // if($("#headline-canvas").length){

//         //   $("#headline-canvas").replaceWith('<input id="pac-input" type="text" placeholder="Enter a location" data-mini="true">');
//         //   autoCompleteSearch();
//         // }
//         // else if($("#pac-input").length){

//         //   $("#pac-input").replaceWith('<h3 id="headline-canvas" align="center">Ebola Viz</h3>');
//         // }

//     });
// });

$(document).on("pageinit", "#ebola", function () {

    $("#btn-search").click(function () {


        if ($("#pac-input").is(":visible")) {
            $("#pac-input").hide();
        }
        else {
            $("#pac-input").show();
        }


    });

    getcurrentlatlong();

});


</script>

<script> <!-- Script influenza -->

var mapInfl;
var geocoderInfl;
var centerInfl = new google.maps.LatLng(-34.397, 150.644);
var e_centerInfl = new google.maps.LatLng(9.430009, -13.083386);
var showedInfoWindowInfl = null;


function getcurrentlatlongInfl() {


    if (navigator.geolocation) {


        navigator.geolocation.getCurrentPosition(onSuccessInfl, onErrorInfl, {enableHighAccuracy: true});

    }
    else {

        alert("navigator.geolocation not supported");
        initializeInfl();

    }

}

function onSuccessInfl(position) {

    var lat = position.coords.latitude;
    var lng = position.coords.longitude;

    centerInfl = new google.maps.LatLng(lat, lng);

    initializeInfl();

}

function onErrorInfl(error) {

    alert("Getting the error" + error.code + "\nerror mesg :" + error.message);
}


function initializeInfl() {
    geocoderInfl = new google.maps.Geocoder();


    var myOptions = {
        zoom: 2,
        streetViewControl: false,
        mapTypeId: google.maps.MapTypeId.ROADMAP,
        center: centerInfl,
        mapTypeControl: false
    };
    mapInfl = new google.maps.Map(d3.select("#gmap-influenza").node(), myOptions);


    var currentLocMarker = new google.maps.Marker({

        position: centerInfl,
        map: mapInfl,
        animation: google.maps.Animation.BOUNCE
    });

    var input = /** @type {HTMLInputElement}*/ (
            document.getElementById('pac-input-influenza'));


    mapInfl.controls[google.maps.ControlPosition.TOP_LEFT].push(input);


    var autocomplete = new google.maps.places.Autocomplete(input);
    autocomplete.bindTo('bounds', mapInfl);

    var infowindow = new google.maps.InfoWindow();
    var scMarker = new google.maps.Marker({
        map: mapInfl,
        anchorPoint: new google.maps.Point(0, -29)
    });

    google.maps.event.addListener(autocomplete, 'place_changed', function () {
        infowindow.close();
        scMarker.setVisible(false);
        var place = autocomplete.getPlace();
        if (!place.geometry) {
            return;
        }

        // If the place has a geometry, then present it on a map.
        if (place.geometry.viewport) {
            mapInfl.fitBounds(place.geometry.viewport);
        } else {
            mapInfl.setCenter(place.geometry.location);
            mapInfl.setZoom(4);  // Why 17? Because it looks good.
        }
        scMarker.setIcon(/** @type {google.maps.Icon} */({
            url: place.icon,
            size: new google.maps.Size(71, 71),
            origin: new google.maps.Point(0, 0),
            anchor: new google.maps.Point(17, 34),
            scaledSize: new google.maps.Size(35, 35)
        }));
        scMarker.setPosition(place.geometry.location);
        scMarker.setVisible(true);

        var address = '';
        if (place.address_components) {
            address = [
                (place.address_components[0] && place.address_components[0].short_name || ''),
                (place.address_components[1] && place.address_components[1].short_name || ''),
                (place.address_components[2] && place.address_components[2].short_name || '')
            ].join(' ');
        }

        infowindow.setContent('<div><strong>' + place.name + '</strong><br>' + address);
        infowindow.open(mapInfl, scMarker);
    });
    
    // Fix Google Maps v3 load partially on top left corner on compiled iOS device.
    google.maps.event.addListenerOnce(mapInfl, 'idle', function() {
       google.maps.event.trigger(mapInfl, 'resize');
       mapInfl.setCenter(centerInfl); // Reset to GPS current center.
    });

    // Start parsing data source html page. http://gamapserver.who.int/gareports/Default.aspx?ReportNo=2

    // The function below will safely parse simple HTML and return a DOM object which can be manipulated like web page elements. This will remove tags like <script>, <style>, <head>, <body>, <title>, and <iframe>. It will also remove all JavaScript, including element attributes that contain JavaScript.
    function HTMLParser(aHTMLString) {
        var html = document.implementation.createDocument("http://www.w3.org/1999/xhtml", "html", null),
                body = document.createElementNS("http://www.w3.org/1999/xhtml", "body");
        html.documentElement.appendChild(body);

        body.appendChild(Components.classes["@mozilla.org/feed-unescapehtml;1"]
                .getService(Components.interfaces.nsIScriptableUnescapeHTML)
                .parseFragment(aHTMLString, false, null, body));

        return body;
    }

    // Get string representation from the data source url.
    $.get("http://gamapserver.who.int/gareports/Default.aspx?ReportNo=2", function (response) {
        // Check the type of the response object
        // console.log(Object.prototype.toString.call(response)); 

        // Parse the response string to DOM.
        var parser = new DOMParser();
        // Extremely important!! set "text/html" NOT "text/xml"
        var doc = parser.parseFromString(response, "text/html");
        var inflWeek = doc.querySelector("#ctl_ReportVieweroReportCell > table > tbody > tr:nth-child(1) > td > table > tbody > tr > td > table > tbody > tr:nth-child(4) > td > table > tbody > tr:nth-child(2) > td > table > tbody > tr:nth-child(1) > td:nth-child(9) > table > tbody > tr > td").innerHTML;

        // Array of objects to store countries and number of cases.
        var influenzaData = [];
        // Countries and cases line starts from 4.
        var lineNumber = 4;
        while (true) {
            var currentLine = "#ctl_ReportVieweroReportCell > table > tbody > tr:nth-child(1) > td > table > tbody > tr > td > table > tbody > tr:nth-child(4) > td > table > tbody > tr:nth-child(2) > td > table > tbody > tr:nth-child(3) > td > table > tbody > tr:nth-child(2) > td > table > tbody > tr:nth-child(2) > td > table > tbody > tr:nth-child(2) > td > table > tbody > tr > td:nth-child(1) > table > tbody > tr:nth-child(" + lineNumber + ")";
            if (doc.querySelector(currentLine) == null) {
                break;
            }
            var curCountryPath = currentLine + " > td:nth-child(1) > div";
            if (doc.querySelector(curCountryPath) == null) {
                break;
            }
            var curCountry = doc.querySelector(curCountryPath).innerHTML;

            var curCasesPath = currentLine + " > td:nth-child(14) > div";
            var curCases = doc.querySelector(curCasesPath).innerHTML;


            var caseByCountry = {country: curCountry, numberOfCases: curCases};
            influenzaData.push(caseByCountry);


            // console.log(curCountry, curCases);


            lineNumber += 1;

        }
        // console.log(influenzaData.length);


        // Load the cases data as circles on map.


        var overlayInfl = new google.maps.OverlayView();
        // Add the container when the overlay is added to the map.
        overlayInfl.onAdd = function () {
            var layer = d3.select(this.getPanes().overlayLayer).append("div")
                    .attr("class", "locations");


            overlayInfl.draw = function () {
                // Scale radious of circle
                var radiusScale = d3.scale.sqrt() // Use sqrt scale
                        .domain([0, d3.max(influenzaData, function (d) {

                            return parseInt(d.numberOfCases);


                        })]) // Change the range according to the zoom level. Influenza has different zoom level than Ebola.
                        .range([0.6 , 1.8]);
                // Scale opacity of circle
                var opacityScale = d3.scale.linear() // Use linear scale
                        .domain([0, d3.max(influenzaData, function (d) {

                            return parseInt(d.numberOfCases);

                        })]) // Skip country level lines while calculating maximum
                        .range([0.52, 0.95]);


                var marker = layer.selectAll("svg")
                        .data(influenzaData)

                        .enter().append("svg")
                        .each(transform);

                // The circle radius is in meters. Due to the map projection, one meter at the equator is smaller than one meter at a higher latitude. So a circle of the same size will appear larger at higher latitudes. To make your circles in pixel sizes, use the map projection fromPointToLatLng and fromLatLngToPoint methods (and draw your own circle, the native google.maps.Circle uses the projection).   
                function drawCircle(center, radius, projection) {
                          var i, angle, x1, y1;
                          var circle = [];
                          var point = projection.fromLatLngToPoint(center);
                          var x = point.x;
                          var y = point.y;
                          for (var i = 0; i < 360; i += 10) {
                            angle = i;
                            x1 = radius * Math.cos(angle * Math.PI / 180);
                            y1 = radius * Math.sin(angle * Math.PI / 180);
                            circle.push(projection.fromPointToLatLng(new google.maps.Point(x + x1, y + y1)));
                          }
                          return circle;
                        }
                function transform(d) {
                    // console.log(d.numberOfCases);
                    if (d.numberOfCases != "0") {


                        var self = this;
                        var address = d.country;

                        

                        // Convert address to latlong, then draw red circle on the map
                        function geoProcess() {
                            geocoderInfl.geocode({'address': address}, function (results, status) {
                                        if (status == google.maps.GeocoderStatus.OK) {
                                            var numOfCases = parseInt(d.numberOfCases);
                                            var projection = mapInfl.getProjection();


                                            var casesOptions = {
                                                strokeColor: '#FF0000',
                                                strokeOpacity: 0,
                                                strokeWeight: 0,

                                                fillColor: '#FF0000',
                                                fillOpacity: opacityScale(numOfCases),
                                                map: mapInfl,
                                                center: results[0].geometry.location,
                                                radius: radiusScale(numOfCases),
                                                path: drawCircle(results[0].geometry.location, radiusScale(numOfCases), projection) // Change from meter measure to pixel measure.
                                            };
                                            // console.log(d.country, numOfCases, radiusScale(numOfCases));
                                            // console.log(results[0].geometry.location);
                                            // Add the circle for this city to the map.
                                            caseCircle = new google.maps.Polygon(casesOptions);


                                            var infowindow = new google.maps.InfoWindow({
                                                content: '<p>' + "<strong>Location: </strong>" + address + "<br>" + "<strong>Positive cases: </strong>" + numOfCases + "<br>" + "<strong>Week: </strong>" + inflWeek + "<br>" + "<strong>Data source: </strong>" + "FluNet" + "</p>"
                                            });

                                            google.maps.event.addListener(caseCircle, 'click', function () {
                                                if (showedInfoWindowInfl) {
                                                    showedInfoWindowInfl.close();
                                                }
                                                infowindow.open(mapInfl, caseCircle);
                                                infowindow.setPosition(results[0].geometry.location);
                                                showedInfoWindowInfl = infowindow;
                                            });
                                        }

                                        // Google geocoder only permit 16 queries at once for free.
                                        // If OVER_QUERY_LIMIT happens, retry later.
                                        else if (status === google.maps.GeocoderStatus.OVER_QUERY_LIMIT) {
                                            // console.log("OVER_QUERY_LIMIT");
                                            setTimeout(function () {
                                                geoProcess();
                                                // }, 200);
                                            }, Math.floor(Math.random() * 2000));  // Randomize the retry process retry time to mitigate the OVER_QUERY_LIMIT a bit.
                                        } else {
                                            alert("Geocode was not successful for the following reason: " + status);

                                        }
                                    }
                            )
                            ;
                        }

                        geoProcess();
                    }


                }
            };


        };

        // Bind our overlay to the map…
        overlayInfl.setMap(mapInfl);

    });
}
$(document).on("pageinit", "#influenza", function () {

    $("#btn-search-influenza").click(function () {


        if ($("#pac-input-influenza").is(":visible")) {
            $("#pac-input-influenza").hide();
        }
        else {
            $("#pac-input-influenza").show();
        }


    });

    getcurrentlatlongInfl();

});


</script>


<script>  // Script for Ebola trend visualization
function getEbolaTrend() {

    var margin = {top: 25, right: 15, bottom: 80, left: 30},
            width = screen.width - margin.left - margin.right,
            height = screen.height - 36 - margin.top - margin.bottom;


    var parseDate = d3.time.format("%d %B %Y").parse; // Pay attention to the format difference %d %B %Y

    var x = d3.time.scale()
            .range([0, width]);

    var y = d3.scale.linear()
            .range([height, 0]);

    var color = d3.scale.category10();

    var xAxis = d3.svg.axis()
            .scale(x)
            .orient("bottom")
            .ticks(9);

// xAxis.ticks(d3.time.day, 2000); 

    var yAxis = d3.svg.axis()
            .scale(y)
            .orient("left");


    var line = d3.svg.line()
            .interpolate("basis")
            .x(function (d) {
                return x(d.date);
            })
            .y(function (d) {
                return y(d.cases);
            });

    var svg = d3.select("#ebolaTrendViz").append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");


// Get latest date, WHO updates Ebola every Wednesday
    var today = new Date(); // Sat Mar 28 2015 23:47:31 GMT-0700 (PDT)
    var lastWednDay = today.getDate() - today.getDay() - 4; //18
    var date = new Date(today.setDate(lastWednDay)); // Wed Mar 18 2015 23:46:57 GMT-0700 (PDT)


    Date.prototype.yyyymmdd = function () {

        var yyyy = this.getFullYear().toString();
        var mm = (this.getMonth() + 1).toString(); // getMonth() is zero-based
        var dd = this.getDate().toString();

        return yyyy + '-' + (mm[1] ? mm : "0" + mm[0]) + '-' + (dd[1] ? dd : "0" + dd[0]);
    };
    var dpi = date.yyyymmdd(); // e.g. 2015-04-15
    var latest_ebolatrend_url = "http://apps.who.int/gho/athena/xmart/xmart.csv?target=EBOLA_MEASURE/CASES&profile=crosstable&filter=LOCATION:-;COUNTRY:GIN;COUNTRY:LBR;COUNTRY:SLE;INDICATOR_TYPE:SITREP_NEW;DATAPACKAGEID:" + dpi + ";SEX:-&x-sideaxis=EPI_WEEK&x-topaxis=COUNTRY;EBOLA_DATA_SOURCE;INDICATOR_TYPE;CASE_DEFINITION";


    // Read in the raw text and clean up the data, then parse
    d3.xhr(latest_ebolatrend_url).get(function (err, response) {
        var dirtyCSV = response.responseText;
        var cleanCSV = dirtyCSV.split('\n').slice(4)
        // Delete last empty line
        cleanCSV.pop();

        cleanCSV = cleanCSV.map(function (row) {
            var rowArray = row.replace("^\"|\"$", "").replace(/['"]+/g, '').split(",");
            // var rowArray = row.split(",");

            var dateMod = rowArray[0].replace(/['"]+/g, '').split(" "); // Delete quotes in string

            // var dateMod = rowArray[0].split(" "); // Delete quotes in string

            if (dateMod.length == 5) { // e.g. 03 to 09 February 2014
                dateMod = dateMod.slice(0, 1).concat(dateMod.slice(3));
            } else if (dateMod.length == 6) { // e.g. 27 January to 02 February 2014

                dateMod = dateMod.slice(0, 2).concat(dateMod.slice(5));

            } else if (dateMod.length == 7) { // e.g. 30 December 2013 to 05 January 2014

                dateMod = dateMod.slice(0, 3);
                // alert(Object.prototype.toString.call(dateMod[0]));


            }

            dateMod = dateMod.join(" ");


            // console.log(dateMod);
            // rowArray[3] = rowArray[3].replace(/['"]+/g, '')
            // console.log(rowArray[3]);


            return dateMod + "," + rowArray[3] + "," + rowArray[7] + "," + rowArray[11];
        });

        // Convert array back to string
        cleanCSV = cleanCSV.join('\n');
        // Add column description to the first line
        cleanCSV = "Week,Guinea,Liberia,Sierra Leone\n" + cleanCSV;
        // console.log(cleanCSV);
        var data = d3.csv.parse(cleanCSV);
        // console.log(data);


        // })

        // d3.csv("is.csv", function (error, data) {
        // // console.log(d3.keys(data[0]).filter(function (key) {
        // //     return key !== "date";
        // // }));
        color.domain(d3.keys(data[0]).filter(function (key) {
            return key !== "Week";
        }));

        data.forEach(function (d) {
            // alert(Object.prototype.toString.call(d["Guinea"]));
            // console.log(d.Week);
            d.Week = parseDate(d.Week);
            // console.log(d.Week);

        });

        var cities = color.domain().map(function (name) {
            return {
                name: name,
                values: data.map(function (d) {
                    return {date: d.Week, cases: +d[name]};
                })
            };
        });
        // console.log(cities);

        x.domain(d3.extent(data, function (d) {

            return d.Week;
        }));

        y.domain([
            d3.min(cities, function (c) {
                return d3.min(c.values, function (v) {
                    return v.cases;
                });
            }),
            d3.max(cities, function (c) {
                return d3.max(c.values, function (v) {
                    return v.cases;
                });
            })
        ]);

        svg.append("g")
                .attr("class", "x axis")
                .attr("transform", "translate(0," + height + ")")
                .call(xAxis)
                .selectAll("text")
                .style("text-anchor", "end")
                .attr("dx", "-.8em")
                .attr("dy", ".15em")
                .attr("transform", function (d) {
                    return "rotate(-65)"
                })

                .style("font-size", "10px"); //To change the font size of texts;

        svg.append("g")
                .attr("class", "y axis")
                .call(yAxis)
                .append("text")
                .attr("transform", "rotate(-90)")
                .attr("y", 6)
                .attr("dy", ".80em")

                .style("text-anchor", "end")
                .text("Cases")
                .style("font-size", "12px");

        var city = svg.selectAll(".city")
                .data(cities)
                .enter().append("g")
                .attr("class", "city");

        city.append("path")
                .attr("class", "line")
                .attr("d", function (d) {
                    // console.log(d.values);
                    return line(d.values);
                })
                .style("stroke", function (d) {
                    // console.log(color(d.name));
                    return color(d.name);
                });

        city.append("text")
                .datum(function (d) { // Choose the dot location to put the text name.
                    return {name: d.name, value: d.values[d.values.length - 10]};
                })
                .attr("transform", function (d) { // Get the dot coordinate
                    return "translate(" + x(d.value.date) + "," + y(d.value.cases) + ")";
                })
                .attr("x", 0)  // Set x,y padding to make text above center of the dot to avoid overlap
                .attr("y", -15)
            // .attr("dy", "1em")
                .text(function (d) { // Display country names
                    return d.name;
                })
                .style("font-size", "8px")
                .attr("fill", function (d) { // Note the different attrs between CSS and D3 notation, e.g. fill and color
                    return color(d.name)
                });
    });
}


$(document).on("pageinit", "#ebolaTrend", function () {

    getEbolaTrend();
});


</script>

<script>

function compare() {

    var margin = {top: 20, right: 20, bottom: 30, left: 40},
        width = screen.width - margin.left - margin.right,
        height = screen.height - margin.top - margin.bottom;

    var x0 = d3.scale.ordinal()
        .rangeRoundBands([0, width], .1);

    var x1 = d3.scale.ordinal();

    var y = d3.scale.linear()
        .range([height, 0]);

    var color = d3.scale.category10();

    var xAxis = d3.svg.axis()
        .scale(x0)
        .orient("bottom");

    var yAxis = d3.svg.axis()
        .scale(y)
        .orient("left")
        .tickFormat(d3.format(".2s"));

    var svg = d3.select("#compareViz").append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
      .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    d3.csv("CompareData.csv", function(data) {

        var ageNames = d3.keys(data[0]).filter(function(key) { return key !== "country"; });

        data.forEach(function(d) {
            d.ages = ageNames.map(function(name) { return {name: name, value: +d[name]}; });
          });

        x0.domain(data.map(function(d) { return d.country; }));

        x1.domain(ageNames).rangeRoundBands([0, x0.rangeBand()]);

        y.domain([0, d3.max(data, function(d) { return d3.max(d.ages, function(d) { return d.value; }); })]);

        svg.append("g")
            .attr("class", "x axis")
            .attr("transform", "translate(0," + height + ")")
            .call(xAxis);

        svg.append("g")
            .attr("class", "y axis")
            .call(yAxis)
            .append("text")
            .attr("transform", "rotate(-90)")
            .attr("y", 6)
            .attr("dy", ".71em")
            .style("text-anchor", "end")
            .text("Cases");
        var countries = svg.selectAll(".countries")
            .data(data)
            .enter().append("g")
            .attr("class", "g")
            .attr("transform", function(d) { return "translate(" + x0(d.country) + ",0)"; });

        countries.selectAll("rect")
            .data(function(d) { return d.ages; })
            .enter().append("rect")
            .attr("width", x1.rangeBand())
            .attr("x", function(d) { return x1(d.name); })
            .attr("y", function(d) { return y(d.value); })
            .attr("height", function(d) { return height - y(d.value); })
            .style("fill", function(d) { return color(d.name); });

        var legend = svg.selectAll(".legend")
            .data(ageNames.slice().reverse())
            .enter().append("g")
            .attr("class", "legend")
            .attr("transform", function(d, i) { return "translate(0," + i * 20 + ")"; });

        legend.append("rect")
            .attr("x", width - 18)
            .attr("width", 18)
            .attr("height", 18)
            .style("fill", color);

        legend.append("text")
            .attr("x", width - 24)
            .attr("y", 9)
            .attr("dy", ".35em")
            .style("text-anchor", "end")
            .text(function(d) { return d; });
  
    });

}

$(document).on("pageinit", "#compare", function () {

    compare();
});
</script>


<body>
<!-- Ebola -->
<div data-role="page" id="ebola">

    <div data-role="header" data-position="fixed">
        <div class="ui-grid-b">
            <div class="ui-block-a" style="width:15%" align="left">
                <a href="#menuPanel" id="btn-menu"
                   class="ui-btn ui-btn-inline ui-icon-bullets ui-nodisc-icon ui-alt-icon ui-corner-all ui-shadow ui-btn-icon-right ui-btn-icon-notext">Menu</a>
            </div>
            <div class="ui-block-b" style="width:70%" align="center">

                <h3>Ebola Viz</h3>


            </div>
            <div class="ui-block-c" style="width:15%" align="right">
                <a href="#" id="btn-search"
                   class="ui-btn ui-btn-inline ui-icon-search ui-nodisc-icon ui-alt-icon  ui-corner-all ui-shadow ui-btn-icon-right ui-btn-icon-notext">Search</a>
            </div>
        </div>
    </div>
    <div role="main" class="ui-content">
        <div id="gmap"></div>
        <input id="pac-input" type="text" placeholder=" Enter a location" data-mini="true">

    </div>
</div>


<!-- influenza -->
<div data-role="page" id="influenza">

    <div data-role="header" data-position="fixed">
        <div class="ui-grid-b">
            <div class="ui-block-a" style="width:15%" align="left">
                <a href="#menuPanel" id="btn-menu"
                   class="ui-btn ui-btn-inline ui-icon-bullets ui-nodisc-icon ui-alt-icon ui-corner-all ui-shadow ui-btn-icon-right ui-btn-icon-notext">Menu</a>
            </div>
            <div class="ui-block-b" style="width:70%" align="center">

                <h3>Influenza Viz</h3>


            </div>
            <div class="ui-block-c" style="width:15%" align="right">
                <a href="#" id="btn-search-influenza"
                   class="ui-btn ui-btn-inline ui-icon-search ui-nodisc-icon ui-alt-icon  ui-corner-all ui-shadow ui-btn-icon-right ui-btn-icon-notext">Search</a>
            </div>
        </div>


    </div>
    <div role="main" class="ui-content">
        <div id="gmap-influenza"></div>
        <input id="pac-input-influenza" type="text" placeholder=" Enter a location" data-mini="true">


    </div>
</div>


<!-- Ebola Trend -->
<div data-role="page" id="ebolaTrend">
    <div data-role="header" data-position="fixed">

        <div class="ui-grid-b">
            <div class="ui-block-a" style="width:15%" align="left">
                <a href="#menuPanel" id="btn-menu"
                   class="ui-btn ui-btn-inline ui-icon-bullets ui-nodisc-icon ui-alt-icon ui-corner-all ui-shadow ui-btn-icon-right ui-btn-icon-notext">Menu</a>
            </div>
            <div class="ui-block-b" style="width:70%" align="center">

                <h3>Ebola Trend</h3>


            </div>

        </div>

    </div>
    <div role="main" class="ui-content">
        <div id="ebolaTrendViz">
        </div>
    </div>
</div>

<!-- Compare Two disease -->
<div data-role="page" id="compare">
    <div data-role="header" data-position="fixed">

        <div class="ui-grid-b">
            <div class="ui-block-a" style="width:15%" align="left">
                <a href="#menuPanel" id="btn-menu"
                   class="ui-btn ui-btn-inline ui-icon-bullets ui-nodisc-icon ui-alt-icon ui-corner-all ui-shadow ui-btn-icon-right ui-btn-icon-notext">Menu</a>
            </div>
            <div class="ui-block-b" style="width:70%" align="center">

                <h3>Top3 Viz</h3>


            </div>

        </div>

    </div>
    <div role="main" class="ui-content">
        <div id="compareViz">
        </div>
    </div>
</div>

<!-- About -->
<div data-role="page" id="about">
    <div data-role="header" data-position="fixed">
        <div class="ui-grid-b">
            <div class="ui-block-a" style="width:15%" align="left">
                <a href="#menuPanel" id="btn-menu"
                   class="ui-btn ui-btn-inline ui-icon-bullets ui-nodisc-icon ui-alt-icon ui-corner-all ui-shadow ui-btn-icon-right ui-btn-icon-notext">Menu</a>
            </div>
            <div class="ui-block-b" style="width:70%" align="center">

                <h3>About</h3>


            </div>

        </div>
    </div>
    <div role="main" class="ui-content">
        <p> This is an epidemic disease visualization project
        </p>
    </div>

</div>

<!-- Shared menuPanel -->
<div data-role="panel" id="menuPanel" data-display="overlay" data-dismissable="true" data-swipe-close="true"
     data-position-fixed="true">

    <ul data-role="listview" data-theme="a" data-inset="false">
        <li data-theme="b" id="menu-list">Menu List</li>
        <li>
            <a href="#ebola">Ebola</a>
        </li>
        <li>
            <a href="#influenza">Influenza</a>
        </li>
        <li>
            <a href="#ebolaTrend">Ebola Trend</a>
        </li>
        <li>
            <a href="#compare">Comparison</a>
        </li>

        <li data-icon="info">
            <a href="#about">about</a>
        </li>
    </ul>
</div>


</body>
</html>