<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
</head>
<title>Epidemic Disease Visualization</title>
<link rel="stylesheet" href="css/jquery.mobile-1.4.5.min.css"/>
<link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
<script src="js/jquery-2.1.3.js"></script>
<script src="js/jquery.mobile-1.4.5.js"></script>
<script src="d3/d3.min.js"></script>
<script src="js/topojson.js"></script>
<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=true&libraries=places"></script>
<script type="text/javascript" src="cordova.js"></script>
<script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>


<style>


    .ui-page, .ui-header, .ui-content, #gmap {

        margin-top: 20px;
    }

    .ui-panel {
        margin-top: 0px;
    }

    #btn-menu {
        margin-top: 3px;

        margin-left: 5px !important;
    }

    #btn-search {
        margin-top: 3px;

        margin-right: 5px !important;
    }

    .ui-header {

        width: 100%;

        background: WhiteSmoke;
        opacity: 1;
        line-height: 1px;
        max-height: 38px;

    }

    p {
        margin-left: 10px;
    }

    html, body, .ui-page, .ui-content, #gmap {
        position: absolute;
        width: 100%;
        height: 100%;
        padding-left: 0px;
        padding-right: 0px;
        margin-bottom: 0px;
        padding-bottom: 0px;

    }

    .ui-content, #gmap {
        /*height: calc(100% - 35px) !important;*/
        height: calc(100% - 23px) !important;
    }

    #pac-input {
        width: 90% !important;
        margin-top: 5px;

    }

    #menu-list {

        height: 40px !important;
        background-color: #000000;
        border-color: #2B5CDA;
        color: #3A8E6B;
        text-shadow: 0 1px 0 #111;
        font-size: larger;
        font-family: fantasy;
    }

    #menuPanel {
        background-color: WhiteSmoke;
    }

    #pac-input {
        display: none;
    }

    .locations, .locations svg {
        position: absolute;
    }

    .locations svg {
        width: 60px;
        height: 20px;
        padding-right: 100px;
        font: 10px sans-serif;
    }

    .locations circle {
        fill: yellow;
        stroke: black;
        stroke-width: 1.5px;
    }

    .axis path, .axis line {
        fill: none;
        stroke: black;
        shape-rendering: crispEdges;
    }

    .x.axis path {
        display: none;
    }

    .line {
        fill: none;
        stroke: steelblue;
        stroke-width: 1.5px;
    }


</style>


<script>


    $(document).on("pagecreate", function () {
        $("body > [data-role='panel']").panel();

        $("body > [data-role='panel'] [data-role='listview']").listview();
    });


</script>


<script>

    var map;
    var geocoder;
    var center = new google.maps.LatLng(-34.397, 150.644);
    var e_center = new google.maps.LatLng(9.430009, -13.083386);
    var showedInfoWindow = null;

    $(document).on("pageinit", "#ebola", function () {

        $("#btn-search").click(function () {


            if ($("#pac-input").is(":visible")) {
                $("#pac-input").hide();
            }
            else {
                $("#pac-input").show();
            }

            // if($("#headline-canvas").length){

            //   $("#headline-canvas").replaceWith('<input id="pac-input" type="text" placeholder="Enter a location" data-mini="true">');
            //   autoCompleteSearch();
            // }
            // else if($("#pac-input").length){

            //   $("#pac-input").replaceWith('<h3 id="headline-canvas" align="center">Ebola Viz</h3>');
            // }

        });
    });

    


    function getcurrentlatlong() {

        if (navigator.geolocation) {

            navigator.geolocation.getCurrentPosition(onSuccess, onError, {enableHighAccuracy: true});

        }
        else {
            alert("navigator.geolocation not supported");
            initialize();

        }
    }

    function onSuccess(position) {
        var lat = position.coords.latitude;
        var lng = position.coords.longitude;

        center = new google.maps.LatLng(lat, lng);
        initialize();

    }

    function onError(error) {
        alert("Getting the error" + error.code + "\nerror mesg :" + error.message);
    }


    function initialize() {
        geocoder = new google.maps.Geocoder();


        var myOptions = {
            zoom: 7,
            streetViewControl: false,
            mapTypeId: google.maps.MapTypeId.ROADMAP,
            center: center,
            mapTypeControl: false
        };
        map = new google.maps.Map(d3.select("#gmap").node(), myOptions);


        currentLocMarker = new google.maps.Marker({

            position: center,
            map: map,
            animation: google.maps.Animation.BOUNCE
        });

        var input = /** @type {HTMLInputElement} */(
                document.getElementById('pac-input'));


        map.controls[google.maps.ControlPosition.TOP_LEFT].push(input);


        var autocomplete = new google.maps.places.Autocomplete(input);
        autocomplete.bindTo('bounds', map);

        var infowindow = new google.maps.InfoWindow();
        var scMarker = new google.maps.Marker({
            map: map,
            anchorPoint: new google.maps.Point(0, -29)
        });

        google.maps.event.addListener(autocomplete, 'place_changed', function () {
            infowindow.close();
            scMarker.setVisible(false);
            var place = autocomplete.getPlace();
            if (!place.geometry) {
                return;
            }

            // If the place has a geometry, then present it on a map.
            if (place.geometry.viewport) {
                map.fitBounds(place.geometry.viewport);
            } else {
                map.setCenter(place.geometry.location);
                map.setZoom(4);  // Why 17? Because it looks good.
            }
            scMarker.setIcon(/** @type {google.maps.Icon} */({
                url: place.icon,
                size: new google.maps.Size(71, 71),
                origin: new google.maps.Point(0, 0),
                anchor: new google.maps.Point(17, 34),
                scaledSize: new google.maps.Size(35, 35)
            }));
            scMarker.setPosition(place.geometry.location);
            scMarker.setVisible(true);

            var address = '';
            if (place.address_components) {
                address = [
                    (place.address_components[0] && place.address_components[0].short_name || ''),
                    (place.address_components[1] && place.address_components[1].short_name || ''),
                    (place.address_components[2] && place.address_components[2].short_name || '')
                ].join(' ');
            }

            infowindow.setContent('<div><strong>' + place.name + '</strong><br>' + address);
            infowindow.open(map, scMarker);
        });

// Set the url to get the latest data from WHO
// Get latest date
        var today = new Date(); // Sat Mar 28 2015 23:47:31 GMT-0700 (PDT)
        var lastWednDay = today.getDate() - today.getDay() - 4; //18
        var date = new Date(today.setDate(lastWednDay)); // Wed Mar 18 2015 23:46:57 GMT-0700 (PDT)


        Date.prototype.yyyymmdd = function () {

            var yyyy = this.getFullYear().toString();
            var mm = (this.getMonth() + 1).toString(); // getMonth() is zero-based
            var dd = this.getDate().toString();

            return yyyy + '-' + (mm[1] ? mm : "0" + mm[0]) + '-' + (dd[1] ? dd : "0" + dd[0]);
        };
        var dpi = date.yyyymmdd(); // e.g. 2015-03-28

// Get year
        var reportYear = date.getFullYear();

// Get latest week report
        Date.prototype.getWeek = function () {
            var onejan = new Date(this.getFullYear(), 0, 1);
            return Math.ceil((((this - onejan) / 86400000) + onejan.getDay() + 1) / 7);
        };
        var weekNumber = (new Date()).getWeek() - 2;


        var latest_ebola_url = "http://apps.who.int/gho/athena/xmart/DATAPACKAGEID/" + dpi + "?format=csv&profile=text&filter=COUNTRY:*;EPI_WEEK:" + reportYear + "-W" + weekNumber + ";CASE_DEFINITION:CONFIRMED;INDICATOR_TYPE:SITREP_NEW;EBOLA_DATA_SOURCE:SITREP";

        // alert(latest_ebola_url);

// Load the station data. When the data comes back, create an overlay.
        d3.csv(latest_ebola_url, function (data) {

                    var overlay = new google.maps.OverlayView();
                    // Add the container when the overlay is added to the map.
                    overlay.onAdd = function () {
                        var layer = d3.select(this.getPanes().overlayLayer).append("div")
                                .attr("class", "locations");


                        overlay.draw = function () {


                            var marker = layer.selectAll("svg")
                                    .data(data)

                                    .enter().append("svg")
                                    .each(transform)


                            function transform(d) {

                                if (d.Location != "" && d["Display Value"] != "0" && d["Display Value"] != "") {
                                    // alert(d.Location + "  " + d["Display Value"]);

                                    var self = this;
                                    var address = d.Location + ", " + d.Country;

                                    // Convert address to latlong, then draw red circle on the map
                                    function geoProcess(address) {
                                        geocoder.geocode({'address': address}, function (results, status) {
                                                    if (status == google.maps.GeocoderStatus.OK) {


                                                        var casesOptions = {
                                                            strokeColor: '#FF0000',
                                                            strokeOpacity: 0.8,
                                                            strokeWeight: 2,
                                                            fillColor: '#FF0000',
                                                            fillOpacity: 0.35,
                                                            map: map,
                                                            center: results[0].geometry.location,
                                                            radius: Math.sqrt(d.Numeric) * 5000
                                                        };

                                                        // Add the circle for this city to the map.
                                                        caseCircle = new google.maps.Circle(casesOptions);


                                                        var infowindow = new google.maps.InfoWindow({
                                                            content: '<p>' + "<strong>Location: </strong>" + address + "<br>" + "<strong>Confirmed Cases: </strong>" + parseInt(d.Numeric) + "<br>" + "<strong>Epi week: </strong>" + d["Epi week"] + "<br>" + "<strong>Data pakage ID: </strong>" + d["Data package ID"]
                                                            + "<br>" + "<strong>Data source: </strong>" + "WHO Situation report" + "</p>"
                                                        });

                                                        google.maps.event.addListener(caseCircle, 'click', function () {
                                                            if (showedInfoWindow) {
                                                                showedInfoWindow.close();
                                                            }
                                                            infowindow.open(map, caseCircle);
                                                            infowindow.setPosition(results[0].geometry.location);
                                                            showedInfoWindow = infowindow;
                                                        });
                                                    }
                                                    // If OVER_QUERY_LIMIT happens, retry later
                                                    else if (status === google.maps.GeocoderStatus.OVER_QUERY_LIMIT) {
                                                        alert("OVER_QUERY_LIMIT at" + d.Location + "  " + d["Display Value"]);
                                                        setTimeout(function () {
                                                            geoProcess(address);
                                                        }, 200);
                                                    } else {
                                                        alert("Geocode was not successful for the following reason: " + status);

                                                    }
                                                }
                                        )
                                        ;
                                    }

                                    geoProcess(address);
                                }


                            }
                        };


                    };

                    // Bind our overlay to the mapâ€¦
                    overlay.setMap(map);
                }
        )
        ;


    }

    function trend() {
        // var margin = {top: 30, right: 20, botton: 30, left: 50},
        // width = 600 - margin.left - margin.right,
        // height = 270 - margin.top - margin - bottom;

        // var parseData = d3.time.format("%Y%m%d").parse;

        // var x = d3.time.scale().range([0, width]);
        // var y = d3.time.linear().range([height, 0]);

        // var color = d3.scale.category10();

        // var xAxis = d3.svg.axis().scale(x).orient("bottom");
        // var yAxis = d3.svg.axis().scale(y).orient("left");

        // var valueline = d3.svg.line()
        //     .x(function(d) { return x(d.date);})
        //     .y(function(d) { return y(d.outbreak);});

        // var svg = d3.select("#trend")
        //     .append("svg")
        //         .attr("width", width + margin.left + margin.right)
        //         .attr("height", height + margin.top + margin.bottom)
        //     .append("g")
        //         .attr("transform", 
        //           "translate(" + margin.left + "," + margin.top + ")");

        // d3.csv("data2015.csv", function(error, data) {
        //     color.domain(d3.keys(data[0]).filter(function(key) { return key !== "date";}));

        //     data.forEach(function(d) {
        //         d.data = parseData(d.date);

        //     });

        //     var cases = color.domain().map(function(name) { reutrn {
        //         name: name,
        //         value: data.map(function(d) {
        //             return {date: d.date, outbreak: +d[name]};
        //             })
        //         }
        //     });

        //     x.domain(d3.extent(data, function(d) { return d.date;}));

        //     y.domain([
        //         d3.min(cases, function(c) { return d3.min(c.values, function(v) { return v.outbreak; }); }),
        //         d3.max(cases, function(c) { return d3.max(c.values, function(v) { return v.outbreak; }); })
        //     ]);

        //     svg.append("g")
        //         .attr("class", "x axis")
        //         .attr("transform", "translate(0," + height + ")")
        //         .call(xAxis);

        //     svg.append("g")
        //         .attr("class", "y axis")
        //         .call(yAxis)
        //         .append("transform", "rotate(-90)")
        //         .attr("y", 6)
        //         .attr("dy", ".71em")
        //         .style("text-anchor", "end")
        //         .text("Ebola outbreak cases");

        //     var case = svg.selectAll(".case")
        //         .data(cases)
        //         .enter().append("g")
        //         .attr("class", "case");

        //     case.append("path")
        //         .attr("class", "line")
        //         .attr("d", function(d) { return line(d.values); })
        //         .style("stroke", function(d) { return color(d.name); });

        //     case.append("text")
        //         .datum(function(d) { return {name: d.name, value: d.values[d.values.length - 1]};})
        //         .attr("transform", function(d) { return "translate(" + x(d.value.date) + "," + y(d.value.outbreak) + ")"; })
        //         .attr("x", 3)
        //         .attr("dy", ".35em")
        //         .text(function(d) { return d.name; });

        // });
    var margin = {top: 20, right: 20, bottom: 30, left: 40},
        width = 960 - margin.left - margin.right,
        height = 500 - margin.top - margin.bottom;

    var x0 = d3.scale.ordinal()
        .rangeRoundBands([0, width], .1);

    var x1 = d3.scale.ordinal();

    var y = d3.scale.linear()
        .range([height, 0]);

    var color = d3.scale.category10();

    var xAxis = d3.svg.axis()
        .scale(x0)
        .orient("bottom");

    var yAxis = d3.svg.axis()
        .scale(y)
        .orient("left")
        .tickFormat(d3.format(".2s"));

    var svg = d3.select("#trend").append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
      .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    // d3.selectAll(".m")
    //     .on("click", function() {
    //         var date = this.getAttribute("value");

    //         var str;
    //         if(date == "March2015") {
    //             str == "March2015.csv";
    //         } else if(date == "Feb2015") {
    //             str == "Feb2015.csv";
    //         } else if(date == "Jan2015") {
    //             str == "Jan2015.csv";
    //         }

            // document.write(str);
            d3.csv("March2015.csv", function(data) {
              var ageNames = d3.keys(data[0]).filter(function(key) { return key !== "country"; });

              data.forEach(function(d) {
                d.ages = ageNames.map(function(name) { return {name: name, value: +d[name]}; });
              });

              x0.domain(data.map(function(d) { return d.country; }));
              x1.domain(ageNames).rangeRoundBands([0, x0.rangeBand()]);
              y.domain([0, d3.max(data, function(d) { return d3.max(d.ages, function(d) { return d.value; }); })]);

              svg.append("g")
                  .attr("class", "x axis")
                  .attr("transform", "translate(0," + height + ")")
                  .call(xAxis);

              svg.append("g")
                  .attr("class", "y axis")
                  .call(yAxis)
                .append("text")
                  .attr("transform", "rotate(-90)")
                  .attr("y", 6)
                  .attr("dy", ".71em")
                  .style("text-anchor", "end")
                  .text("Numbers");

              var countries = svg.selectAll(".countries")
                  .data(data)
                .enter().append("g")
                  .attr("class", "g")
                  .attr("transform", function(d) { return "translate(" + x0(d.country) + ",0)"; });

              countries.selectAll("rect")
                  .data(function(d) { return d.ages; })
                .enter().append("rect")
                  .attr("width", x1.rangeBand())
                  .attr("x", function(d) { return x1(d.name); })
                  .attr("y", function(d) { return y(d.value); })
                  .attr("height", function(d) { return height - y(d.value); })
                  .style("fill", function(d) { return color(d.name); });

              var legend = svg.selectAll(".legend")
                  .data(ageNames.slice().reverse())
                .enter().append("g")
                  .attr("class", "legend")
                  .attr("transform", function(d, i) { return "translate(0," + i * 20 + ")"; });

              legend.append("rect")
                  .attr("x", width - 18)
                  .attr("width", 18)
                  .attr("height", 18)
                  .style("fill", color);

              legend.append("text")
                  .attr("x", width - 24)
                  .attr("y", 9)
                  .attr("dy", ".35em")
                  .style("text-anchor", "end")
                  .text(function(d) { return d; });

    //On click, update new data
        // });
  
    });

    }

    $(document).on("pageinit", "#ebola", function () {

        getcurrentlatlong();

    });

    $(document).on("pageinit", "#ebolaTrend", function () {

        trend();

    });


</script>



<body>

<div data-role="page" id="ebola">

    <div data-role="header" data-position="fixed">
        <div class="ui-grid-b">
            <div class="ui-block-a" style="width:15%" align="left">
                <a href="#menuPanel" id="btn-menu"
                   class="ui-btn ui-btn-inline ui-icon-bullets ui-nodisc-icon ui-alt-icon ui-corner-all ui-shadow ui-btn-icon-right ui-btn-icon-notext">Menu</a>
            </div>
            <div class="ui-block-b" style="width:70%" align="center">

                <h4 id="headline-canvas" align="center">Ebola Viz</h4>
                <input align="right" id="pac-input" type="text" placeholder="Enter a location" data-mini="true">

            </div>
            <div class="ui-block-c" style="width:15%" align="right">
                <a href="#" id="btn-search"
                   class="ui-btn ui-btn-inline ui-icon-search ui-nodisc-icon ui-alt-icon  ui-corner-all ui-shadow ui-btn-icon-right ui-btn-icon-notext">Search</a>
            </div>
        </div>
    </div>

</div>
<div role="main" class="ui-content">


    <div id="gmap"></div>


</div>


<div data-role="page" id="ebolaTrend">
    <div data-role="header" data-position="fixed">
        <a href="#menuPanel"
           class="ui-btn ui-btn-inline ui-icon-bullets ui-nodisc-icon ui-alt-icon ui-corner-all ui-shadow ui-btn-icon-left ui-btn-icon-notext">Menu</a>

        <div class="ui-blick-b" align="center">
            <h4 id="headline-canvas" align="center">Ebola Trend</h4>

        </div>

        <div class="btn-group pull-right">
        <button type="button" class="btn btn-primary-toggle" data-toggle="dropdown">
            Select Month <span class="caret"></span>
        </button>
        <ul class="dropdown-menu" role="menu">
            <li><a class="m" value="March2015" href="#">March, 2015</a></li>
            <li><a class="m" value="Feb2015" href="#">Feb, 2015</a></li>
            <li><a class="m" value="Jan2015" href="#">Jan, 2015</a></li>
        </ul>
    </div>

    </div>
    
    <div role="main" class="ui-content">
        <div id="trend"></div>
    </div>
</div>

<div data-role="page" id="about">
    <div data-role="header" data-position="fixed">
        <a href="#menuPanel"
           class="ui-btn ui-btn-inline ui-icon-bullets ui-nodisc-icon ui-alt-icon ui-corner-all ui-shadow ui-btn-icon-left ui-btn-icon-notext">Menu</a>

        <h1>About</h1>

    </div>
    <div role="main" class="ui-content">
        <p> This is an epidemic disease visualization project by USF
        </p>
    </div>

</div>

<div data-role="panel" id="menuPanel" data-display="overlay" data-dismissable="true" data-swipe-close="true"
     data-position-fixed="true">

    <ul data-role="listview" data-theme="a" data-inset="false">
        <li data-theme="b" id="menu-list">Menu List</li>
        <li>
            <a href="#ebola">Ebola</a>

        </li>
        <li>
            <a href="#ebolaTrend">Ebola Trend</a>
        </li>

        <li data-icon="info">
            <a href="#about">about</a>
        </li>
    </ul>
</div>


</body>
</html>